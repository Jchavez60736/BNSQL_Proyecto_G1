<body>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>

    <nav aria-label="breadcrumb" class="mb-4">
        <ol class="breadcrumb">
            <li class="breadcrumb-item"><a href="/home">Inicio</a></li>
            <li class="breadcrumb-item active" aria-current="page">Mantenimientos</li>
        </ol>
    </nav>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2">Gestión de Mantenimientos</h1>
        <button class="btn btn-teal" data-bs-toggle="modal" data-bs-target="#modalMantenimiento">
            <i class="bi bi-plus-circle"></i> Nuevo Mantenimiento
        </button>
    </div>

    <div class="card shadow-sm">
        <div class="card-body">
            <div class="table-responsive">
                <table class="table table-hover" id="tablaMantenimientos">
                    <thead class="table-light">
                        <tr>
                            <th>Item</th>
                            <th>Fecha Inicio</th>
                            <th>Fecha Fin</th>
                            <th>Tipo</th>
                            <th>Responsable</th>
                            <th>Resultado</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="cuerpoTabla"></tbody>
                </table>
            </div>
            <div id="sinDatos" class="alert alert-info text-center mt-3" style="display:none;">
                No hay mantenimientos registrados aún.
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalMantenimiento" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="tituloModal">Nuevo Mantenimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="formularioMantenimiento">
                        <input type="hidden" id="idMantenimiento">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="idItem" class="form-label">Item *</label>
                                    <select class="form-control" id="idItem" required>
                                        <option value="">Seleccionar</option>
                                    </select>
                                    <small class="text-muted" id="infoItem"></small>
                                    <small class="text-danger" id="errorIdItem"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="tipoMantenimiento" class="form-label">Tipo de Mantenimiento *</label>
                                    <select class="form-control" id="tipoMantenimiento" required>
                                        <option value="">Seleccionar</option>
                                        <option value="Preventivo">Preventivo</option>
                                        <option value="Correctivo">Correctivo</option>
                                    </select>
                                    <small class="text-danger" id="errorTipoMantenimiento"></small>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="descripcionProcedimiento" class="form-label">Descripción del Procedimiento
                                *</label>
                            <textarea class="form-control" id="descripcionProcedimiento" rows="3" required></textarea>
                            <small class="text-danger" id="errorDescripcionProcedimiento"></small>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fechaInicio" class="form-label">Fecha Inicio *</label>
                                    <input type="date" class="form-control" id="fechaInicio" required>
                                    <small class="text-danger" id="errorFechaInicio"></small>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="fechaFin" class="form-label">Fecha Fin</label>
                                    <input type="date" class="form-control" id="fechaFin">
                                    <small class="text-danger" id="errorFechaFin"></small>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="responsable" class="form-label">Responsable *</label>
                                    <select class="form-control" id="responsable" required>
                                        <option value="">Seleccionar</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="estado" class="form-label">Estado</label>
                                    <select class="form-control" id="estado">
                                        <option value="Activo">Activo</option>
                                        <option value="Cerrado">Cerrado</option>
                                        <option value="Cancelado">Cancelado</option>
                                    </select>
                                </div>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label for="resultado" class="form-label">Resultado</label>
                            <textarea class="form-control" id="resultado" rows="2"></textarea>
                        </div>

                        <div class="mb-3">
                            <label for="observaciones" class="form-label">Observaciones</label>
                            <textarea class="form-control" id="observaciones" rows="2"></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancelar</button>
                    <button type="button" class="btn btn-teal" id="btnGuardar">Guardar</button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="modalDetalles" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Detalles del Mantenimiento</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="detallesContent"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const modalMantenimiento = new bootstrap.Modal(document.getElementById('modalMantenimiento'));
        const modalDetalles = new bootstrap.Modal(document.getElementById('modalDetalles'));
        let editando = false;

        cargarMantenimientos();

        document.getElementById('modalMantenimiento').addEventListener('show.bs.modal', () => {
            if (!editando) {
                cargarItems();
                cargarPersonas();
            }
        });

        document.getElementById('modalMantenimiento').addEventListener('hidden.bs.modal', () => {
            document.getElementById('formularioMantenimiento').reset();
            document.getElementById('idMantenimiento').value = "";
            document.getElementById('tituloModal').innerText = "Nuevo Mantenimiento";
            editando = false;
        });

        document.getElementById('btnGuardar').addEventListener('click', guardarMantenimiento);

        async function cargarMantenimientos() {
            const res = await fetch('/api/mantenimientos');
            const datos = await res.json();

            const cuerpoTabla = document.getElementById('cuerpoTabla');
            const sinDatos = document.getElementById('sinDatos');

            cuerpoTabla.innerHTML = '';

            if (datos.ok && datos.data.length > 0) {
                sinDatos.style.display = 'none';

                datos.data.forEach(m => {
                    cuerpoTabla.innerHTML += `
                        <tr>
                            <td><strong>${m.idItem.nombreItem}</strong></td>
                            <td>${new Date(m.fechaInicio).toLocaleDateString('es-CR')}</td>
                            <td>${new Date(m.fechaFin).toLocaleDateString('es-CR')}</td>
                            <td>${m.tipoMantenimiento}</td>
                            <td>${m.responsable.nombreCompleto}</td>
                            <td>${m.resultado}</td>
                            <td>${m.estado}</td>
                            <td>
                                <button class="btn btn-sm btn-info" onclick="verDetalles('${m._id}')"><i class="bi bi-eye"></i></button>
                                <button class="btn btn-sm btn-warning" onclick="editarMantenimiento('${m._id}')"><i class="bi bi-pencil"></i></button>
                                <button class="btn btn-sm btn-danger" onclick="eliminarMantenimiento('${m._id}')"><i class="bi bi-trash"></i></button>
                            </td>
                        </tr>
                    `;
                });
            } else {
                sinDatos.style.display = 'block';
            }
        }

        async function cargarItems() {
            const res = await fetch('/api/items');
            const datos = await res.json();

            const select = document.getElementById('idItem');
            select.innerHTML = '<option value="">Seleccionar</option>';

            if (datos.ok && datos.data.length > 0) {
                datos.data.forEach(i => {
                    const option = document.createElement('option');
                    option.value = i._id;
                    option.textContent = `${i.nombreItem} (${i.categoria.nombre})`;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = "No hay items registrados";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        async function cargarPersonas() {
            const res = await fetch('/api/personas');
            const datos = await res.json();

            const select = document.getElementById('responsable');
            select.innerHTML = '<option value="">Seleccionar</option>';

            if (datos.ok && datos.data.length > 0) {
                datos.data.forEach(p => {
                    const option = document.createElement('option');
                    option.value = p._id;
                    option.textContent = p.nombreCompleto;
                    select.appendChild(option);
                });
            } else {
                const option = document.createElement('option');
                option.textContent = "No hay personas registradas";
                option.disabled = true;
                select.appendChild(option);
            }
        }

        async function verDetalles(id) {
            const res = await fetch(`/api/mantenimientos/${id}`);
            const datos = await res.json();
            const m = datos.data;

            document.getElementById('detallesContent').innerHTML = `
            <p><strong>Item:</strong> ${m.idItem?.nombreItem || 'Sin nombre'}</p>
            <p><strong>Tipo de Mantenimiento:</strong> ${m.tipoMantenimiento}</p>
            <p><strong>Descripción del Procedimiento:</strong> ${m.descripcionProcedimiento}</p>
            <p><strong>Fecha de Inicio:</strong> ${new Date(m.fechaInicio).toISOString().split("T")[0]}</p>
            <p><strong>Fecha de Finalización:</strong> ${new Date(m.fechaFin).toISOString().split("T")[0]}</p>
            <p><strong>Responsable:</strong> ${m.responsable?.nombreCompleto || 'Sin nombre'}</p>
            <p><strong>Resultado:</strong> ${m.resultado}</p>
            <p><strong>Observaciones:</strong> ${m.observaciones}</p>
            <p><strong>Estado:</strong> ${m.estado}</p>
            `;

            modalDetalles.show();
        }

        async function guardarMantenimiento() {
            const id = document.getElementById('idMantenimiento').value;
            const idItem = document.getElementById('idItem').value;
            const tipoMantenimiento = document.getElementById('tipoMantenimiento').value;
            const descripcionProcedimiento = document.getElementById('descripcionProcedimiento').value.trim();
            const fechaInicio = document.getElementById('fechaInicio').value + "T12:00:00";
            const fechaFin = document.getElementById('fechaFin').value + "T12:00:00";
            const responsable = document.getElementById('responsable').value;
            const estado = document.getElementById('estado').value;
            const resultado = document.getElementById('resultado').value.trim();
            const observaciones = document.getElementById('observaciones').value.trim();

            const datos = { idItem, fechaInicio, fechaFin, tipoMantenimiento, descripcionProcedimiento, responsable, resultado, observaciones, estado };

            const url = editando ? `/api/mantenimientos/${id}` : '/api/mantenimientos';
            const metodo = editando ? 'PUT' : 'POST';

            const res = await fetch(url, {
                method: metodo,
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(datos)
            });

            const data = await res.json();
            if (data.ok) {
                cargarMantenimientos();
                modalMantenimiento.hide();
                alert(editando ? 'Mantenimiento actualizado correctamente' : 'Mantenimiento guardado correctamente');
            } else {
                alert('Error: ' + data.msg);
            }
        }

        async function editarMantenimiento(id) {
            const res = await fetch(`/api/mantenimientos/${id}`);
            const datos = await res.json();

            if (!datos.ok) {
                alert('Error cargando el mantenimiento');
                return;
            }

            const m = datos.data;
            editando = true;

            await cargarItems();
            await cargarPersonas();

            document.getElementById('idMantenimiento').value = m._id;
            document.getElementById('idItem').value = m.idItem._id;
            document.getElementById('tipoMantenimiento').value = m.tipoMantenimiento;
            document.getElementById('descripcionProcedimiento').value = m.descripcionProcedimiento;
            document.getElementById('fechaInicio').value = m.fechaInicio.split('T')[0];
            document.getElementById('fechaFin').value = m.fechaFin.split('T')[0];
            document.getElementById('responsable').value = m.responsable._id;
            document.getElementById('estado').value = m.estado;
            document.getElementById('resultado').value = m.resultado;
            document.getElementById('observaciones').value = m.observaciones;

            document.getElementById('tituloModal').textContent = 'Editar Mantenimiento';
            modalMantenimiento.show();
        }

        async function eliminarMantenimiento(id) {
            if (!confirm('¿Estás seguro de que deseas eliminar este mantenimiento?')) {
                return;
            }

            const res = await fetch(`/api/mantenimientos/${id}`, { method: 'DELETE' });
            const datos = await res.json();

            if (datos.ok) {
                alert('Mantenimiento eliminado correctamente');
                cargarMantenimientos();
            } else {
                alert('Error: ' + datos.msg);
            }
        }
    </script>
</body>